<div id="book-widget"></div>
<div id="status" style="margin-top:10px;color:#b00;"></div>

<!-- Add Book Form -->
<div style="margin-top:20px;">
  <input id="isbn" placeholder="ISBN" />
  <input id="title" placeholder="Title" />
  <input id="author" placeholder="Author" />
  <select id="status">
    <option value="wishlist">Wishlist</option>
    <option value="currently">Currently Reading</option>
  </select>
  <button onclick="addBook()">Add Book</button>
</div>

<script>
  const backendURL = "https://book-widget.vercel.app/api"; // <-- deployed backend (serverless functions)

  function showStatus(msg, isError = false) {
    const el = document.getElementById('status');
    el.style.color = isError ? '#b00' : '#080';
    el.textContent = msg;
    setTimeout(() => { el.textContent = ''; }, 4000);
  }

  // --- Render books by status ---
  async function fetchBooks(status) {
    const res = await fetch(`${backendURL}/books/${status}`);
    return await res.json();
  }

  async function renderList(status, containerId, title) {
    const books = await fetchBooks(status);

    const container = document.createElement("div");
    container.innerHTML = `<h2>${title}</h2>`;
    container.style.marginBottom = "20px";

    for (let book of books) {
      const item = document.createElement("div");
      item.style.display = "inline-block";
      item.style.margin = "10px";
      item.style.textAlign = "center";
      const placeholder = 'https://via.placeholder.com/150x220?text=No+Cover';
      const imgSrc = book.cover || placeholder;
      item.innerHTML = `
        <img src="${imgSrc}" alt="${book.title}" 
             style="height:150px; display:block; margin-bottom:5px;" onerror="this.onerror=null;this.src='${placeholder}';">
        <span>${book.title}</span><br>
        <button onclick="moveBook(${book.id}, '${status}')">
          Move to ${status === 'wishlist' ? 'Currently Reading' : 'Wishlist'}
        </button>
        <button onclick="deleteBook(${book.id})">‚ùå</button>
      `;
      container.appendChild(item);
    }

    document.getElementById(containerId).innerHTML = "";
    document.getElementById(containerId).appendChild(container);
  }

  async function renderAll() {
    document.getElementById("book-widget").innerHTML = `
      <div id="wishlist"></div>
      <div id="currently"></div>
    `;
    await renderList("wishlist", "wishlist", "Wishlist");
    await renderList("currently", "currently", "Currently Reading");
  }

  // --- Add new book ---
  async function addBook() {
    const isbn = document.getElementById("isbn").value.trim();
    const title = document.getElementById("title").value.trim();
    const author = document.getElementById("author").value.trim();
    const status = document.getElementById("status").value;

    try {
      const res = await fetch(`${backendURL}/book`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ isbn, title, author, status })
      });
      if (!res.ok) {
        const body = await res.text();
        showStatus(`Add failed: ${res.status} ${body}`, true);
        return;
      }
      showStatus('Book added');
    } catch (err) {
      showStatus('Network error: ' + err.message, true);
      return;
    }

    await renderAll();

    document.getElementById("isbn").value = "";
    document.getElementById("title").value = "";
    document.getElementById("author").value = "";
  }

  // --- Move book between lists ---
  async function moveBook(id, currentStatus) {
    const newStatus = currentStatus === "wishlist" ? "currently" : "wishlist";
    try {
      const res = await fetch(`${backendURL}/book/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });
      if (!res.ok) {
        const body = await res.text();
        showStatus(`Update failed: ${res.status} ${body}`, true);
        return;
      }
      showStatus('Book moved');
      await renderAll();
    } catch (err) {
      showStatus('Network error: ' + err.message, true);
    }
  }

  // --- Delete book ---
  async function deleteBook(id) {
    try {
      const res = await fetch(`${backendURL}/book/${id}`, { method: "DELETE" });
      if (!res.ok) {
        const body = await res.text();
        showStatus(`Delete failed: ${res.status} ${body}`, true);
        return;
      }
      showStatus('Book deleted');
      await renderAll();
    } catch (err) {
      showStatus('Network error: ' + err.message, true);
    }
  }

  // --- Initial render ---
  renderAll();
</script>
